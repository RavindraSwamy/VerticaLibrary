create procedure EDW.spin_load_MPESA_T0111()
begin
  truncate table edw.S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA;
  commit work;
  load into table edw.S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA( SOURCE_PARTY_ID '~^~',source_system_code '~^~',NAME_prefix '~^~',First_NAME '~^~',middle_NAME '~^~',Last_name '~^~',Full_name '~^~',Birth_DATE '~^~',Gender '~^~',MARITAL_STATUS '~^~',pan_nbr '~^~',Special_category '~^~',PER_ADDRESS_LINE1 '~^~',PER_ADDRESS_LINE2 '~^~',PER_ADDRESS_LINE3 '~^~',PER_ADDRESS_LINE4 '~^~',PER_CITY '~^~',PER_PIN '~^~',PER_COUNTRY '~^~',CUR_ADDRESS_LINE1 '~^~',CUR_ADDRESS_LINE2 '~^~',CUR_ADDRESS_LINE3 '~^~',CUR_ADDRESS_LINE4 '~^~',CUR_CITY '~^~',CUR_PIN '~^~',CUR_COUNTRY '~^~',CURPHONE1 '~^~',MOBILENUMBER '~^~',DATE_CREATED '\x0A' ) using file
    '/sybase_load/LOAD_MANAGEMENT/MPESA/ACCOUNT/t0111_source_customer_details_mpesa.out' quotes off escapes off preview on ignore constraint all 0 message log '/sybase_load/LOAD_MANAGEMENT/MPESA/ACCOUNT/t0111_source_customer_details_mpesa.msg' row log '/sybase_load/LOAD_MANAGEMENT/MPESA/ACCOUNT/t0111_source_customer_details_mpesa.row' only log all log delimited by '~' notify 100000 with checkpoint on;
  insert into edw.LOAD_SUMMARY_T0111
    select 'MPESA','S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA',dateformat(getdate(),'yyyy-mm-dd'),'S table Inserted Records',@@rowcount;
  commit work;
  delete from edw.S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA as A from edw.S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA as A
    ,(select MAX(ROWID(S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA)) as ROW_ID,
      SOURCE_PARTY_ID,
      SOURCE_SYSTEM_CODE from edw.S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA
      group by SOURCE_PARTY_ID,SOURCE_SYSTEM_CODE) as B
    where A.SOURCE_PARTY_ID = B.SOURCE_PARTY_ID
    and A.SOURCE_SYSTEM_CODE = B.SOURCE_SYSTEM_CODE
    and ROWID(A) <> B.ROW_ID;
  insert into edw.LOAD_SUMMARY_T0111
    select 'MPESA','S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA',dateformat(getdate(),'yyyy-mm-dd'),'Duplicate deleted Records',@@rowcount;
  commit work;
  insert into edw.T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM
    ( SOURCE_PARTY_ID,
    source_system_code,
    NAME_prefix,
    First_NAME,
    middle_NAME,
    Last_name,
    Full_name,
    Birth_DATE,
    Gender,
    MARITAL_STATUS,
    pan_nbr,
    Special_category,
    PER_ADDRESS_LINE1,
    PER_ADDRESS_LINE2,
    PER_ADDRESS_LINE3,
    PER_ADDRESS_LINE4,
    PER_CITY,
    PER_PIN,
    PER_COUNTRY,
    CUR_ADDRESS_LINE1,
    CUR_ADDRESS_LINE2,
    CUR_ADDRESS_LINE3,
    CUR_ADDRESS_LINE4,
    CUR_CITY,
    CUR_PIN,
    CUR_COUNTRY,
    CURPHONE1,
    MOBILENUMBER,
    DATE_CREATED ) 
    select S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.SOURCE_PARTY_ID,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.source_system_code,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.NAME_prefix,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.First_NAME,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.middle_NAME,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.Last_name,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.Full_name,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.Birth_DATE,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.Gender,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.MARITAL_STATUS,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.pan_nbr,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.Special_category,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.PER_ADDRESS_LINE1,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.PER_ADDRESS_LINE2,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.PER_ADDRESS_LINE3,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.PER_ADDRESS_LINE4,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.PER_CITY,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.PER_PIN,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.PER_COUNTRY,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.CUR_ADDRESS_LINE1,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.CUR_ADDRESS_LINE2,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.CUR_ADDRESS_LINE3,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.CUR_ADDRESS_LINE4,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.CUR_CITY,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.CUR_PIN,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.CUR_COUNTRY,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.CURPHONE1,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.MOBILENUMBER,
      S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA.DATE_CREATED
      from EDW.S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA;
  insert into edw.LOAD_SUMMARY_T0111
    select 'MPESA','S_T0111_SOURCE_CUSTOMER_DETAILS_MPESA',dateformat(getdate(),'yyyy-mm-dd'),'Inserted  Records',@@rowcount;
  commit work
end
