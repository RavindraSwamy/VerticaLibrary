create procedure EDW.spin_load_EBOR_T0111()
begin
  create table #UPS_T0111_SOURCE_CUSTOMER_DETAILS_EBOR(
    SOURCE_PARTY_ID varchar(50) null,
    SYB_SOURCE_PARTY_ID varchar(50) null,
    SOURCE_SYSTEM_CODE smallint null,
    SYB_SOURCE_SYSTEM_CODE smallint null,
    ROLE_CD smallint null,
    SYB_ROLE_CD smallint null,
    );
  truncate table edw.S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR;
  commit work;
  load into table edw.S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR( SOURCE_PARTY_ID '^|',SOURCE_SYSTEM_CODE '^|',IND_ORG_CODE '^|',FULL_NAME '^|',BIRTH_DATE '^|',GENDER '^|',PAN_NBR '^|',ROLE_CD '^|',PER_ADDRESS_LINE1 '^|',PER_ADDRESS_LINE2 '^|',PER_ADDRESS_LINE3 '^|',PER_ADDRESS_LINE4 '^|',PER_CITY '^|',PER_STATE '^|',PER_PIN '^|',PER_COUNTRY '^|',PERPHONE1 '^|',PERPHONE2 '^|',CUR_ADDRESS_LINE1 '^|',CUR_ADDRESS_LINE2 '^|',CUR_ADDRESS_LINE3 '^|',CUR_ADDRESS_LINE4 '^|',CUR_CITY '^|',CUR_STATE '^|',CUR_PIN '^|',CUR_COUNTRY '^|',CURPHONE1 '^|',CURPHONE2 '^|',EADDRESS '^|',FAXNUMBER '^|',MOBILENUMBER '^|',DATE_CREATED '^|',DATE_LAST_MODIFIED '^|',PER_EADDRESS '^|',PER_MOBILENUMBER '^|',CUR_EADDRESS '^|',CUR_MOBILENUMBER '\x0A' ) using file
    '/sybase_load/LOAD_MANAGEMENT/DEMAT/ACCOUNT/YET_TO_LOAD_FILES/t0111_source_customer_details_ebor.out' quotes off escapes off preview on ignore constraint all 0 message log '/sybase_load/LOAD_MANAGEMENT/DEMAT/LOAD_LOGS/ERROR_RECORDS_MSSG/t0111_source_customer_details_ebor_201208061244.msg' row log '/sybase_load/LOAD_MANAGEMENT/DEMAT/LOAD_LOGS/ERROR_RECORDS_DATA/t0111_source_customer_details1_ebor_201208061244.row' only log all log delimited by '^|' notify 100000 with checkpoint on;
  insert into edw.LOAD_SUMMARY_T0111
    select 'EBOR','T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM',dateformat(getdate(),'yyyy-mm-dd'),'S table Inserted Records',@@rowcount;
  commit work;
  delete from edw.S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR as A from
    edw.S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR as A
    ,(select MAX(ROWID(S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR)) as ROW_ID,
      SOURCE_PARTY_ID,
      SOURCE_SYSTEM_CODE,ROLE_CD from edw.S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR
      group by SOURCE_PARTY_ID,ROLE_CD,
      SOURCE_SYSTEM_CODE) as B
    where A.SOURCE_PARTY_ID = B.SOURCE_PARTY_ID
    and A.SOURCE_SYSTEM_CODE = B.SOURCE_SYSTEM_CODE
    and A.ROLE_CD = B.ROLE_CD
    and ROWID(A) <> B.ROW_ID;
  insert into edw.LOAD_SUMMARY_T0111
    select 'EBOR','T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM',dateformat(getdate(),'yyyy-mm-dd'),'Duplicate deleted Records',@@rowcount;
  commit work;
  update EDW.T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM
    set T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.SOURCE_PARTY_ID = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_PARTY_ID,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.SOURCE_SYSTEM_CODE = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_SYSTEM_CODE,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.IND_ORG_CODE = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.IND_ORG_CODE,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.FULL_NAME = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.FULL_NAME,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.BIRTH_DATE = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.BIRTH_DATE,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.GENDER = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.GENDER,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PAN_NBR = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PAN_NBR,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.ROLE_CD = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.ROLE_CD,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PER_ADDRESS_LINE1 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_ADDRESS_LINE1,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PER_ADDRESS_LINE2 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_ADDRESS_LINE2,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PER_ADDRESS_LINE3 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_ADDRESS_LINE3,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PER_ADDRESS_LINE4 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_ADDRESS_LINE4,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PER_CITY = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_CITY,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PER_STATE = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_STATE,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PER_PIN = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_PIN,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PER_COUNTRY = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_COUNTRY,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PERPHONE1 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PERPHONE1,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PERPHONE2 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PERPHONE2,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CUR_ADDRESS_LINE1 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_ADDRESS_LINE1,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CUR_ADDRESS_LINE2 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_ADDRESS_LINE2,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CUR_ADDRESS_LINE3 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_ADDRESS_LINE3,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CUR_ADDRESS_LINE4 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_ADDRESS_LINE4,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CUR_CITY = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_CITY,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CUR_STATE = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_STATE,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CUR_PIN = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_PIN,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CUR_COUNTRY = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_COUNTRY,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CURPHONE1 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CURPHONE1,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CURPHONE2 = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CURPHONE2,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.EADDRESS = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.EADDRESS,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.FAXNUMBER = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.FAXNUMBER,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.MOBILENUMBER = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.MOBILENUMBER,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.DATE_CREATED = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.DATE_CREATED,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.DATE_LAST_MODIFIED = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.DATE_LAST_MODIFIED,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PER_EADDRESS = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_EADDRESS,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.PER_MOBILENUMBER = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_MOBILENUMBER,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CUR_EADDRESS = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_EADDRESS,
    T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.CUR_MOBILENUMBER = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_MOBILENUMBER from
    EDW.T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM,EDW.S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR
    where T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.SOURCE_PARTY_ID = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_PARTY_ID
    and T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.SOURCE_SYSTEM_CODE = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_SYSTEM_CODE
    and T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.ROLE_CD = S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.ROLE_CD;
  insert into edw.LOAD_SUMMARY_T0111
    select 'EBOR','T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM',dateformat(getdate(),'yyyy-mm-dd'),'Updated  Records',@@rowcount;
  commit work;
  insert into #UPS_T0111_SOURCE_CUSTOMER_DETAILS_EBOR
    select S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_PARTY_ID,
      T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.SOURCE_PARTY_ID as SYB_SOURCE_PARTY_ID,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_SYSTEM_CODE,
      T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.SOURCE_SYSTEM_CODE as SYB_SOURCE_SYSTEM_CODE,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.ROLE_CD,
      T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.ROLE_CD as SYB_ROLE_CD
      from EDW.S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR left outer join EDW.T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM
        on S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_PARTY_ID = T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.SOURCE_PARTY_ID
        and S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_SYSTEM_CODE = T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.SOURCE_SYSTEM_CODE
        and S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.ROLE_CD = T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM.ROLE_CD;
  commit work;
  insert into EDW.T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM
    ( SOURCE_PARTY_ID,
    SOURCE_SYSTEM_CODE,
    IND_ORG_CODE,
    FULL_NAME,
    BIRTH_DATE,
    GENDER,
    PAN_NBR,
    ROLE_CD,
    PER_ADDRESS_LINE1,
    PER_ADDRESS_LINE2,
    PER_ADDRESS_LINE3,
    PER_ADDRESS_LINE4,
    PER_CITY,
    PER_STATE,
    PER_PIN,
    PER_COUNTRY,
    PERPHONE1,
    PERPHONE2,
    CUR_ADDRESS_LINE1,
    CUR_ADDRESS_LINE2,
    CUR_ADDRESS_LINE3,
    CUR_ADDRESS_LINE4,
    CUR_CITY,
    CUR_STATE,
    CUR_PIN,
    CUR_COUNTRY,
    CURPHONE1,
    CURPHONE2,
    EADDRESS,
    FAXNUMBER,
    MOBILENUMBER,
    DATE_CREATED,
    DATE_LAST_MODIFIED,
    PER_EADDRESS,
    PER_MOBILENUMBER,
    CUR_EADDRESS,
    CUR_MOBILENUMBER ) 
    select S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_PARTY_ID,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_SYSTEM_CODE,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.IND_ORG_CODE,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.FULL_NAME,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.BIRTH_DATE,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.GENDER,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PAN_NBR,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.ROLE_CD,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_ADDRESS_LINE1,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_ADDRESS_LINE2,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_ADDRESS_LINE3,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_ADDRESS_LINE4,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_CITY,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_STATE,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_PIN,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_COUNTRY,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PERPHONE1,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PERPHONE2,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_ADDRESS_LINE1,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_ADDRESS_LINE2,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_ADDRESS_LINE3,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_ADDRESS_LINE4,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_CITY,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_STATE,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_PIN,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_COUNTRY,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CURPHONE1,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CURPHONE2,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.EADDRESS,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.FAXNUMBER,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.MOBILENUMBER,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.DATE_CREATED,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.DATE_LAST_MODIFIED,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_EADDRESS,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.PER_MOBILENUMBER,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_EADDRESS,
      S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.CUR_MOBILENUMBER
      from EDW.S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR,EDW.#UPS_T0111_SOURCE_CUSTOMER_DETAILS_EBOR
      where S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_PARTY_ID = #UPS_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_PARTY_ID
      and #UPS_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SYB_SOURCE_PARTY_ID is null
      and S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_SYSTEM_CODE = #UPS_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SOURCE_SYSTEM_CODE
      and #UPS_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SYB_SOURCE_SYSTEM_CODE is null
      and S_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.ROLE_CD = #UPS_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.ROLE_CD
      and #UPS_T0111_SOURCE_CUSTOMER_DETAILS_EBOR.SYB_ROLE_CD is null;
  insert into edw.LOAD_SUMMARY_T0111
    select 'EBOR','T0111_SOURCE_CUSTOMER_DETAILS_EXTERNAL_SYSTEM',dateformat(getdate(),'yyyy-mm-dd'),'Inserted  Records',@@rowcount;
  commit work
end
